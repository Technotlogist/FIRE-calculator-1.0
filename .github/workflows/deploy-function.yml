# .github/workflows/deploy-function.yml
name: Deploy Cloud Function (FIRE Plan Generator)

on:
  push:
    branches:
      - main  # Trigger deployment on push to the main branch
    paths:
      - 'cloud-function/**' # Only run if files in the function folder change

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      # Step 1: Checks out the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Authenticate to Google Cloud using Workload Identity Federation
      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          # IMPORTANT: Replace [PROJECT_NUMBER] with your actual Google Cloud Project Number!
          workload_identity_provider: projects/[PROJECT_NUMBER]/locations/global/workloadIdentityPools/github-pool/providers/github-actions
          service_account: github-deployer@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com 
          
      # Step 3: Deploy the Cloud Function
      - name: Deploy to Cloud Function
        uses: 'google-github-actions/deploy-cloud-functions@v2'
        with:
          name: 494683889335
          runtime: nodejs20
          region: us-central1 # Use your chosen region
          entry_point: generateAndSendEmail
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          source_dir: 'cloud-function' 
          trigger_http: true
          allow_unauthenticated: true
          env_vars: GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}

      # Step 4: Output the Function URL
      - name: Get function URL
        id: get_url
        run: |
          gcloud functions describe generateAndSendFirePlan \
            --region us-central1 \
            --format='value(url)' > function_url.txt
          echo "FUNCTION_URL=$(cat function_url.txt)" >> $GITHUB_OUTPUT
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
