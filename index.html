<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Path to Financial Independence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 320px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .gradient-text {
            background: linear-gradient(to right, #00A0F0, #00F0B5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .ai-output-card {
            min-height: 150px;
            background-color: #f8fafc; 
            border: 1px solid #e2e8ff;
        }
        .input-box {
            border: 2px solid #e2e8f0;
            padding: 0.5rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: #334155;
            width: 100%;
            max-width: 250px;
            margin: 0 auto;
        }
        .input-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748b;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-700">

    <main class="container mx-auto p-4 md:p-8">

        <header class="text-center my-12">
            <h1 class="text-4xl md:text-6xl font-black tracking-tight gradient-text">The Path to Financial Independence</h1>
            <p class="mt-4 text-lg md:text-xl text-slate-600 max-w-3xl mx-auto">Input your current financial figures to calculate your personalized FIRE timeline and access AI-powered strategies.</p>
        </header>
        
        <!-- Interactive Input Section -->
        <section class="mb-16 bg-white p-6 md:p-8 rounded-xl shadow-lg border border-slate-100">
            <div class="text-center mb-10">
                <h2 class="text-3xl font-bold text-slate-800">Your Financial Snapshot</h2>
                <p class="mt-2 text-md text-slate-500 max-w-2xl mx-auto">Enter your numbers to begin the calculation.</p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-6 text-center">
                
                <div class="p-4 rounded-xl border border-slate-100 md:col-span-1">
                    <input type="number" id="currentNwInput" value="100000" min="0" class="input-box bg-slate-50">
                    <div class="input-label">Current Net Worth ($)</div>
                </div>

                <div class="p-4 rounded-xl border border-slate-100 md:col-span-1">
                    <input type="number" id="annualIncInput" value="80000" min="0" class="input-box bg-slate-50">
                    <div class="input-label">Annual Income (Net $)</div>
                </div>

                <div class="p-4 rounded-xl border border-slate-100 md:col-span-1">
                    <input type="number" id="annualExpInput" value="30000" min="0" class="input-box bg-slate-50">
                    <div class="input-label">Annual Expenses ($)</div>
                </div>

                <div class="p-4 rounded-xl border border-slate-100 md:col-span-1">
                    <input type="number" id="realReturnInput" value="5" min="0.1" max="15" step="0.1" class="input-box bg-slate-50">
                    <div class="input-label">Real Annual Return (%)</div>
                </div>
                
                <div class="p-4 rounded-xl border border-slate-100 md:col-span-1">
                    <input type="number" id="swrMultiplierInput" value="25" min="20" max="33.3" step="0.5" class="input-box bg-slate-50">
                    <div class="input-label">SWR Multiplier (x)</div>
                </div>
            </div>
        </section>

        <!-- Dynamic Results Section -->
        <section class="mb-16">
            <div class="text-center mb-10">
                <h2 class="text-3xl font-bold text-slate-800">Your Calculated Timeline</h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 text-center">
                <div class="bg-white p-6 rounded-xl shadow-md border border-slate-100">
                    <div class="text-4xl font-extrabold text-[#00A0F0]" id="annualSavingsDisplay">$50,000</div>
                    <div class="text-sm font-semibold text-slate-500 mt-1">Annual Savings</div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md border border-slate-100">
                    <div class="text-4xl font-extrabold text-[#00A0F0]" id="savingsRateDisplay">62.5%</div>
                    <div class="text-sm font-semibold text-slate-500 mt-1">Savings Rate</div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md border border-slate-100">
                    <div class="text-4xl font-extrabold text-[#00F0B5]" id="fireGoalDisplay">$750,000</div>
                    <div class="text-sm font-semibold text-slate-500 mt-1">Your FIRE Goal</div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-xl border-2 border-[#00A0F0]">
                    <div class="text-4xl font-extrabold text-slate-800" id="yearsToFireDisplay">9.87 Years</div>
                    <div class="text-sm font-semibold text-slate-500 mt-1">Years Until FIRE</div>
                </div>
            </div>
        </section>


        <section class="mb-16">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg border border-slate-100">
                    <h3 class="text-2xl font-bold text-slate-800">The Engine of FIRE: Your Savings Rate</h3>
                    <p class="mt-2 text-slate-600">The single most important factor in your FIRE journey isn't how much you earn, but how much you save. A higher savings rate dramatically shortens your timeline to financial independence. This doughnut chart shows your current income distribution based on your inputs.</p>
                    <div class="mt-4 text-center">
                      <p class="text-5xl font-extrabold text-[#00A0F0]" id="savingsRateDisplay2">62.5%</p>
                      <p class="font-semibold text-slate-500">Savings Rate</p>
                    </div>
                </div>
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg border border-slate-100">
                    <div class="chart-container">
                        <canvas id="savingsRateChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section class="mb-16 bg-white p-6 md:p-8 rounded-xl shadow-lg border border-slate-100">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-slate-800">The Impact of Lifestyle: FIRE Scenarios</h2>
                <p class="mt-2 text-md text-slate-500 max-w-3xl mx-auto">Your desired lifestyle in retirement dramatically changes your target and timeline. See how "Lean," "Standard," and "Fat" FIRE goals compare based on your current savings rate.</p>
            </div>
            <div class="chart-container">
                <canvas id="fireScenariosChart"></canvas>
            </div>
        </section>

        <section class="mb-16 bg-white p-6 md:p-8 rounded-xl shadow-lg border border-slate-100">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-slate-800">Visualizing Your Growth</h2>
                <p class="mt-2 text-md text-slate-500 max-w-3xl mx-auto">The power of compound interest is your greatest ally. This chart projects the growth of your net worth over time until you hit your calculated FIRE goal, based on your inputted return rate.</p>
            </div>
            <div class="chart-container">
                <canvas id="growthChart"></canvas>
            </div>
        </section>

        <!-- Gemini API Powered Features -->
        <section class="mb-16">
            <div class="text-center mb-10">
                <h2 class="text-3xl font-bold text-slate-800">Accelerate Your Plan with AI</h2>
                <p class="mt-2 text-md text-slate-500 max-w-2xl mx-auto">Leverage the Gemini API to get actionable insights and strategies tailored to your financial goals.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Feature 1: Strategy Deep Dive (Grounded Search) -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-100 flex flex-col">
                    <h3 class="text-xl font-bold text-[#00A0F0] mb-3">1. ✨ Strategy Deep Dive</h3>
                    <p class="text-slate-600 mb-4 text-sm">Get a high-level, current, and grounded strategy focused on maximizing your savings rate and optimizing investments for your calculated FIRE goal.</p>
                    
                    <button id="strategyBtn" class="w-full py-3 px-4 bg-[#00A0F0] text-white font-bold rounded-lg shadow-md hover:bg-[#0090D0] transition duration-200 disabled:bg-slate-400">
                        Get Grounded Strategy
                    </button>

                    <div id="strategyOutput" class="ai-output-card mt-4 p-4 rounded-lg overflow-auto">
                        <p class="text-slate-400 text-sm">Click the button to generate a strategy.</p>
                    </div>
                </div>

                <!-- Feature 2: Expense Optimization (Non-Grounded) -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-slate-100 flex flex-col">
                    <h3 class="text-xl font-bold text-[#00F0B5] mb-3">2. ✨ Expense Optimization</h3>
                    <p class="text-slate-600 mb-4 text-sm">Brainstorm 5 specific, unconventional ways to trim your current annual expenses and further accelerate your timeline.</p>
                    
                    <button id="expenseBtn" class="w-full py-3 px-4 bg-[#00F0B5] text-slate-800 font-bold rounded-lg shadow-md hover:bg-[#00D090] transition duration-200 disabled:bg-slate-400">
                        Generate Optimization Ideas
                    </button>

                    <div id="expenseOutput" class="ai-output-card mt-4 p-4 rounded-lg overflow-auto">
                        <p class="text-slate-400 text-sm">Click the button to generate ideas.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Personalized Email Funnel Section -->
        <section class="mb-16">
            <div class="text-center mb-10">
                <h2 class="text-3xl font-bold text-slate-800">Lock In Your Plan: Get a Personalized Email</h2>
                <p class="mt-2 text-md text-slate-500 max-w-2xl mx-auto">Enter your email and tell us how you feel about your timeline. We'll send you a complete AI-generated strategy and optimization plan based on your numbers.</p>
            </div>

            <div class="bg-[#00F0B5]/10 p-8 rounded-xl shadow-2xl max-w-2xl mx-auto border-4 border-[#00F0B5]">
                <form id="emailFunnelForm" class="space-y-6">
                    <div>
                        <label for="userEmail" class="block text-lg font-semibold text-slate-700 mb-1">Your Email Address</label>
                        <input type="email" id="userEmail" required placeholder="name@example.com" class="w-full p-3 rounded-lg border-2 border-slate-300 focus:border-[#00A0F0] transition">
                    </div>

                    <div>
                        <label for="personalPrompt" class="block text-lg font-semibold text-slate-700 mb-1">Your Thoughts/Goal</label>
                        <textarea id="personalPrompt" rows="3" required placeholder="e.g., 'I feel discouraged by the 15 years, what's the fastest way to cut that down?' or 'I want to know the best high-yield investment options right now.'" class="w-full p-3 rounded-lg border-2 border-slate-300 focus:border-[#00A0F0] transition"></textarea>
                    </div>

                    <button type="submit" id="funnelSubmitBtn" class="w-full py-4 text-xl bg-[#00A0F0] text-white font-black rounded-lg shadow-xl hover:bg-[#0070B0] transition duration-300">
                        Generate My Plan and Email Me!
                    </button>
                </form>

                <div id="funnelOutput" class="mt-6 text-sm text-slate-700 hidden">
                    <p class="font-bold text-lg text-green-700 mb-2">Success! (Payload Generated)</p>
                    <p>Below is the data your system needs to send to the Gemini API and your email automation service. **(In a real application, this would be submitted to a server.)**</p>
                    <pre id="payloadDisplay" class="bg-slate-800 text-green-300 p-4 rounded-lg mt-2 overflow-auto text-xs"></pre>
                </div>
            </div>
        </section>


    </main>
    
    <footer class="text-center p-8 mt-12 border-t border-slate-200">
        <p class="text-slate-500">Start your own journey to Financial Independence today. Small changes can lead to big results over time.</p>
    </footer>

    <script>
        const FONT_COLOR = '#334155';
        Chart.defaults.color = FONT_COLOR;
        Chart.defaults.font.family = "'Inter', 'sans-serif'";

        // --- Global Chart Instances ---
        let savingsRateChart, fireScenariosChart, growthChart;
        
        // --- Global State Variables for Funnel and AI ---
        let futureGoal = 750000;
        let annualExpenses = 30000;
        let annualIncome = 80000;
        let annualSavings = 50000;
        let savingsRate = 62.5;
        let yearsToFire = 9.87;
        let currentNetWorth = 100000;
        let realReturnRate = 5;

        // --- LLM Utility Functions ---
        const apiKey = "";
        const BASE_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/";

        const MAX_RETRIES = 5;
        
        async function retryFetch(url, options, maxRetries = MAX_RETRIES) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function fetchGeminiData(modelName, systemInstructionText, userQuery, useGrounding = false) {
            const url = `${BASE_API_URL}${modelName}:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemInstructionText }]
                },
            };

            if (useGrounding) {
                payload.tools = [{ "google_search": {} }];
            }

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await retryFetch(url, options);
                const result = await response.json();
                
                const candidate = result.candidates?.[0];
                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                    return { text: "Error: Could not retrieve a valid response from the AI model.", sources: [] };
                }

                const text = candidate.content.parts[0].text;
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;

                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                return { text, sources };

            } catch (error) {
                console.error("Gemini API call failed:", error);
                return { text: `Error: Failed to connect to the AI service. (${error.message})`, sources: [] };
            }
        }

        // --- Chart.js Configuration ---

        const sharedTooltipOptions = {
            plugins: {
                tooltip: {
                    callbacks: {
                        title: function(tooltipItems) {
                            const item = tooltipItems[0];
                            let label = item.chart.data.labels[item.dataIndex];
                            if (Array.isArray(label)) {
                              return label.join(' ');
                            } else {
                              return label;
                            }
                        }
                    }
                }
            }
        };

        // Function to initialize charts only once
        function initializeCharts() {
            const savingsRateCtx = document.getElementById('savingsRateChart').getContext('2d');
            savingsRateChart = new Chart(savingsRateCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Savings', 'Expenses'],
                    datasets: [{
                        data: [62.5, 37.5], 
                        backgroundColor: ['#00A0F0', '#00F0B5'],
                        borderColor: ['#FFFFFF'],
                        borderWidth: 4,
                        hoverOffset: 8
                    }]
                },
                options: {
                    ...sharedTooltipOptions,
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        ...sharedTooltipOptions.plugins,
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 14,
                                    weight: '600'
                                }
                            }
                        }
                    }
                }
            });

            const fireScenariosCtx = document.getElementById('fireScenariosChart').getContext('2d');
            fireScenariosChart = new Chart(fireScenariosCtx, {
                type: 'bar',
                data: {
                    labels: ['Lean FIRE ($20k/yr)', 'Standard FIRE ($30k/yr)', 'Fat FIRE ($80k/yr)'],
                    datasets: [{
                        label: 'Years to FIRE',
                        data: [7.28, 9.87, 21.41], 
                        backgroundColor: ['#00F0B5', '#00A0F0', '#F0A000'],
                        borderRadius: 6
                    }]
                },
                options: {
                    ...sharedTooltipOptions,
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                display: true,
                                color: '#e2e8f0'
                            },
                            title: {
                                display: true,
                                text: 'Years to Achieve Goal',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                            }
                            }
                        },
                        y: {
                           grid: {
                               display: false
                           }
                        }
                    },
                    plugins: {
                        ...sharedTooltipOptions.plugins,
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            const growthCtx = document.getElementById('growthChart').getContext('2d');
            growthChart = new Chart(growthCtx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Net Worth',
                        data: [{x: 0, y: 100000}, {x: 9.87, y: 750000}], 
                        borderColor: '#00A0F0',
                        backgroundColor: 'rgba(0, 160, 240, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                    }]
                },
                options: {
                    ...sharedTooltipOptions,
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Years from Today',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                               display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Net Worth ($)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value, index, values) {
                                    return '$' + (value / 1000) + 'k';
                                }
                            },
                             grid: {
                                display: true,
                                color: '#e2e8f0'
                            }
                        }
                    },
                    plugins: {
                        ...sharedTooltipOptions.plugins,
                        legend: {
                            display: false
                        },
                        tooltip: {
                             ...sharedTooltipOptions.plugins.tooltip,
                             callbacks: {
                                ...sharedTooltipOptions.plugins.tooltip.callbacks,
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y);
                                    }
                                    return label;
                                },
                                 title: function(tooltipItems) {
                                    const item = tooltipItems[0];
                                    const year = item.parsed.x.toFixed(2);
                                    return `Year ${year}`;
                                 }
                             }
                        }
                    }
                }
            });
        }
        
        // NPER calculation function - returns the number of periods (years)
        function NPER(rate, payment, presentValue, futureValue) {
            if (rate === 0) {
                return (futureValue - presentValue) / payment;
            }
            const rateDecimal = rate / 100;
            // The formula is slightly adjusted for financial functions where PV is typically negative (money flowing out)
            // But for simplicity in JS, we use -PV for the calculation
            return Math.log((futureValue * rateDecimal + payment) / (presentValue * rateDecimal + payment)) / Math.log(1 + rateDecimal);
        }

        // Calculates investment growth points for the line chart
        function calculateGrowthData(pv, pmt, rate, years, goal) {
            let data = [];
            let currentVal = pv;
            const step = Math.min(1, years / 20); 
            
            for (let i = 0; i < years; i += step) {
                data.push({x: i, y: currentVal});
                currentVal = currentVal * (1 + (rate/100) * step) + pmt * step;
            }
            data.push({x: years, y: goal}); 
            return data;
        }

        // Core calculation and render function
        function calculateAndRender() {
            const nw = parseFloat(document.getElementById('currentNwInput').value) || 0;
            const inc = parseFloat(document.getElementById('annualIncInput').value) || 0;
            const exp = parseFloat(document.getElementById('annualExpInput').value) || 0;
            const ratePercent = parseFloat(document.getElementById('realReturnInput').value) || 5;
            const swrMult = parseFloat(document.getElementById('swrMultiplierInput').value) || 25;
            
            annualSavings = inc - exp;
            annualExpenses = exp;
            annualIncome = inc;
            currentNetWorth = nw;
            realReturnRate = ratePercent;
            
            if (inc > 0) {
                savingsRate = (annualSavings / inc) * 100;
            } else {
                savingsRate = 0;
            }

            futureGoal = exp * swrMult;
            
            if (annualSavings <= 0) {
                yearsToFire = Infinity;
            } else if (nw >= futureGoal) {
                yearsToFire = 0;
            } else {
                yearsToFire = NPER(ratePercent, annualSavings, -nw, futureGoal);
            }

            // 1. Update Display Metrics
            document.getElementById('annualSavingsDisplay').textContent = annualSavings.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
            document.getElementById('savingsRateDisplay').textContent = `${savingsRate.toFixed(1)}%`;
            document.getElementById('savingsRateDisplay2').textContent = `${savingsRate.toFixed(1)}%`;
            document.getElementById('fireGoalDisplay').textContent = futureGoal.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
            
            if (yearsToFire === Infinity) {
                document.getElementById('yearsToFireDisplay').textContent = 'Never (Saving 0)';
            } else if (yearsToFire <= 0) {
                 document.getElementById('yearsToFireDisplay').textContent = 'Achieved!';
            }
            else {
                document.getElementById('yearsToFireDisplay').textContent = `${yearsToFire.toFixed(2)} Years`;
            }

            // 2. Update Savings Rate Chart
            savingsRateChart.data.datasets[0].data = [savingsRate, Math.max(0, 100 - savingsRate)];
            savingsRateChart.update();

            // 3. Update FIRE Scenarios Chart
            const leanExp = 20000;
            const standardExp = 30000;
            const fatExp = 80000;

            const leanGoal = leanExp * swrMult;
            const standardGoal = standardExp * swrMult;
            const fatGoal = fatExp * swrMult;

            const leanYears = NPER(ratePercent, annualSavings, -nw, leanGoal);
            const standardYears = NPER(ratePercent, annualSavings, -nw, standardGoal);
            const fatYears = NPER(ratePercent, annualSavings, -nw, fatGoal);

            fireScenariosChart.data.datasets[0].data = [
                leanYears > 50 ? 50 : Math.max(0, leanYears), 
                standardYears > 50 ? 50 : Math.max(0, standardYears), 
                fatYears > 50 ? 50 : Math.max(0, fatYears)
            ];
            fireScenariosChart.data.labels = [
                `Lean FIRE ($${leanExp.toLocaleString()}/yr)`, 
                `Standard FIRE ($${standardExp.toLocaleString()}/yr)`, 
                `Fat FIRE ($${fatExp.toLocaleString()}/yr)`
            ];
            fireScenariosChart.options.scales.x.max = Math.max(50, Math.ceil(standardYears / 10) * 10);

            fireScenariosChart.update();

            // 4. Update Growth Chart
            if (yearsToFire > 0 && yearsToFire < 100) {
                growthChart.data.datasets[0].data = calculateGrowthData(nw, annualSavings, ratePercent, yearsToFire, futureGoal);
                growthChart.options.scales.x.max = Math.ceil(yearsToFire);
                growthChart.options.scales.y.max = futureGoal * 1.05;
            } else {
                 growthChart.data.datasets[0].data = [{x: 0, y: nw}, {x: 1, y: nw}]; 
                 growthChart.options.scales.x.max = 1;
                 growthChart.options.scales.y.max = nw * 1.5;
            }

            growthChart.update();
        }

        window.onload = function() {
            initializeCharts();
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', calculateAndRender);
            });
            calculateAndRender(); 
            
            document.getElementById('emailFunnelForm').addEventListener('submit', generateEmailPayload);
        };

        // --- Funnel Payload Generation Logic ---
        function generateEmailPayload(event) {
            event.preventDefault();

            const userEmail = document.getElementById('userEmail').value;
            const personalPrompt = document.getElementById('personalPrompt').value;
            const funnelOutputDiv = document.getElementById('funnelOutput');
            const payloadDisplay = document.getElementById('payloadDisplay');

            // 1. Construct the Gemini Queries using the current calculated state
            const strategyQuery = `My current FIRE plan calculated the following: Years to FIRE: ${yearsToFire.toFixed(2)}, FIRE Goal: $${futureGoal.toLocaleString()}, Annual Expenses: $${annualExpenses.toLocaleString()}, Savings Rate: ${savingsRate.toFixed(1)}%. My personal prompt is: "${personalPrompt}". Provide a grounded strategy focused on my numbers AND addressing my personal prompt.`;
            
            const expenseQuery = `My current annual expenses are $${annualExpenses.toLocaleString('en-US', { maximumFractionDigits: 0 })}. My personal prompt is: "${personalPrompt}". Generate 5 unconventional, high-impact ways to cut these costs, also considering my personal prompt/feeling.`;

            // 2. Build the full payload object
            const payload = {
                timestamp: new Date().toISOString(),
                user_data: {
                    email: userEmail,
                    personal_prompt: personalPrompt
                },
                financial_summary: {
                    current_net_worth: currentNetWorth,
                    annual_income: annualIncome,
                    annual_expenses: annualExpenses,
                    annual_savings: annualSavings,
                    real_return_rate: realReturnRate,
                    savings_rate_percent: savingsRate,
                    fire_goal: futureGoal,
                    years_to_fire: yearsToFire.toFixed(2)
                },
                gemini_api_requests: {
                    strategy_system_prompt: "Act as a certified financial advisor specializing in accelerating FIRE timelines. Provide a concise, highly-actionable strategy (3-5 bullet points minimum) for the individual, focusing on maximizing the savings rate and optimizing investment returns based on current best practices. The response should be empathetic and highly motivational.",
                    strategy_user_query: strategyQuery,
                    expense_system_prompt: "You are a creative cost-cutting consultant. Generate exactly 5 unconventional and highly specific recommendations for reducing annual expenses, tailored to the user's specific expense level and emotional state/goal. Do not provide common advice like 'cancel subscriptions' or 'cook at home.' Focus on high-impact, actionable, and unique ideas. Present the ideas as a numbered list.",
                    expense_user_query: expenseQuery
                }
            };

            // 3. Display the JSON payload
            payloadDisplay.textContent = JSON.stringify(payload, null, 2);
            funnelOutputDiv.classList.remove('hidden');

            // In a real application, you would use fetch() here to send 'payload' to your server/email webhook
            // Example: fetch('/api/process-fire-funnel', { method: 'POST', body: JSON.stringify(payload) });
            
            // Disable button briefly for UX
            const submitBtn = document.getElementById('funnelSubmitBtn');
            submitBtn.textContent = 'Plan Generated!';
            submitBtn.disabled = true;
            setTimeout(() => {
                submitBtn.textContent = 'Generate My Plan and Email Me!';
                submitBtn.disabled = false;
            }, 3000);
        }

        // --- Existing LLM Feature Logic (kept for on-page usage) ---
        document.getElementById('strategyBtn').addEventListener('click', async () => {
            const btn = document.getElementById('strategyBtn');
            const outputDiv = document.getElementById('strategyOutput');
            const currentSavingsRate = savingsRate.toFixed(1);
            
            btn.disabled = true;
            btn.textContent = 'Analyzing Plan...';
            outputDiv.innerHTML = '<div class="flex items-center justify-center h-full"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-[#00A0F0] mr-2"></div>Loading Strategy...</div>';

            const systemPrompt = "Act as a certified financial advisor specializing in accelerating FIRE timelines. Provide a concise, highly-actionable strategy (3-5 bullet points minimum) for the individual, focusing on maximizing the savings rate and optimizing investment returns based on current best practices. The response should be empathetic and highly motivational.";
            const userQuery = `My current financial situation is: FIRE goal of $${futureGoal.toLocaleString()}, $${annualExpenses.toLocaleString()} annual expenses, and a ${currentSavingsRate}% savings rate. Provide a grounded strategy to accelerate reaching this goal and securing my future.`;
            
            const { text, sources } = await fetchGeminiData('gemini-2.5-flash-preview-05-20', systemPrompt, userQuery, true);
            
            outputDiv.innerHTML = `<div class="prose max-w-none text-sm text-slate-700">${text.replace(/\n/g, '<br>')}</div>`;

            if (sources.length > 0) {
                let sourceHtml = '<p class="mt-4 text-xs font-semibold text-slate-500">Sources:</p><ul class="list-disc list-inside text-xs text-slate-500 space-y-1">';
                sources.slice(0, 3).forEach((src) => {
                    sourceHtml += `<li><a href="${src.uri}" target="_blank" class="text-[#00A0F0] hover:underline">${src.title || src.uri}</a></li>`;
                });
                sourceHtml += '</ul>';
                outputDiv.innerHTML += sourceHtml;
            }
            
            btn.disabled = false;
            btn.textContent = 'Get Grounded Strategy';
        });

        document.getElementById('expenseBtn').addEventListener('click', async () => {
            const btn = document.getElementById('expenseBtn');
            const outputDiv = document.getElementById('expenseOutput');
            
            btn.disabled = true;
            btn.textContent = 'Brainstorming Ideas...';
            outputDiv.innerHTML = '<div class="flex items-center justify-center h-full"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-[#00F0B5] mr-2"></div>Loading Ideas...</div>';

            const systemPrompt = "You are a creative cost-cutting consultant. Generate exactly 5 unconventional and highly specific recommendations for reducing annual expenses, tailored to the user's specific expense level. Do not provide common advice like 'cancel subscriptions' or 'cook at home.' Focus on high-impact, actionable, and unique ideas. Present the ideas as a numbered list.";
            const userQuery = `My current annual expenses are $${annualExpenses.toLocaleString('en-US', { maximumFractionDigits: 0 })}. Generate 5 unconventional ways to cut these costs.`;
            
            const { text } = await fetchGeminiData('gemini-2.5-flash-preview-05-20', systemPrompt, userQuery, false);
            
            outputDiv.innerHTML = `<div class="prose max-w-none text-sm text-slate-700">${text.replace(/\n/g, '<br>')}</div>`;
            
            btn.disabled = false;
            btn.textContent = 'Generate Optimization Ideas';
        });

    </script>
</body>
</html>
